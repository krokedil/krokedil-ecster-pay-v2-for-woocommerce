jQuery(function(_){const u={wc_ecster_initialized:!1,ecster_cart_key:null,wc_ecster_on_customer_authenticated_data:!1,wc_ecster_on_changed_delivery_address_data:!1,ecster_cart_key:ecster_wc_params.ecster_checkout_cart_key,wc_ecster_order_processing:!1,paymentMethodEl:_('input[name="payment_method"]'),selectAnotherSelector:"#ecster-checkout-select-other",bodyEl:_("body"),init:function(){u.checkIfSelected()&&(_(document).ready(u.documentReady()),u.bodyEl.on("updated_checkout",u.wc_ecster_update_cart)),u.bodyEl.on("change",'input[name="payment_method"]',u.maybeChangeToEcster),u.bodyEl.on("click",u.selectAnotherSelector,function(){u.changePaymentMethod(!1)}),u.bodyEl.on("change",'input[name="ecster-customer-type"]',u.wc_ecster_update_cart)},documentReady:function(){u.wc_ecster_body_class(),u.moveExtraCheckoutFields(),u.wc_ecster_create_cart()},checkIfSelected:function(){return 0<u.paymentMethodEl.length&&(u.paymentMethod=u.paymentMethodEl.filter(":checked").val(),"ecster"===u.paymentMethod)},wc_ecster_body_class:function(){"ecster"===_("input[name='payment_method']:checked").val()?_("body").addClass("ecster-selected").removeClass("ecster-deselected"):_("body").removeClass("ecster-selected").addClass("ecster-deselected")},moveExtraCheckoutFields:function(){_(".woocommerce-additional-fields").appendTo("#ecster-extra-checkout-fields");var e=_('form[name="checkout"] input, form[name="checkout"] select, textarea');for(i=0;i<e.length;i++){var c=e[i].name;_("table.woocommerce-checkout-review-order-table").find(e[i]).length||-1===_.inArray(c,ecster_wc_params.standard_woo_checkout_fields)&&(0<_("p#"+c+"_field").length?_("p#"+c+"_field"):_('input[name="'+c+'"]').closest("p")).appendTo("#ecster-extra-checkout-fields")}},wc_ecster_create_cart:function(){console.log("create"),"ecster"===_("input[name='payment_method']:checked").val()&&"object"==typeof window.EcsterPay&&_("#ecster-pay-ctr").length&&(null!==u.ecster_cart_key&&!0!==u.ecster_cart_key.includes("Error")?EcsterPay.start({cartKey:u.ecster_cart_key,shopTermsUrl:ecster_wc_params.terms,showCart:!1,showPaymentResult:!1,onCheckoutStartInit:function(){_("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutStartSuccess:function(){_("#order_review").unblock(),u.wc_ecster_initialized=!0,_("body").trigger("update_checkout")},onCheckoutStartFailure:function(e){_("#order_review").unblock(),console.log("onCheckoutStartFailure"),console.log(e),u.wc_ecster_on_checkout_start_failure(e)},onCheckoutUpdateInit:function(){_("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutUpdateSuccess:function(){_("#order_review").unblock(),_("#ecster-pay-ctr").unblock()},onCheckoutUpdateFailure:function(){_("#order_review").unblock()},onCustomerAuthenticated:function(e){u.wc_ecster_on_customer_authenticated_data=e.customer,u.wc_ecster_on_customer_authenticated(e.customer)},onChangedDeliveryMethod:function(e){},onChangedDeliveryAddress:function(e){u.wc_ecster_on_changed_delivery_address_data=e,u.wc_ecster_on_changed_delivery_address(e)},onPaymentSuccess:function(e){u.wc_ecster_on_payment_success(e)},onPaymentFailure:function(){u.wc_ecster_fail_local_order("failed")},onPaymentDenied:function(e){u.wc_ecster_fail_local_order("denied")},onBeforeSubmit:function(e,c){u.logToFile('Received "onBeforeSubmit" callback from Ecster.'),console.log("onBeforeSubmit"),console.log(e),console.log(c),u.processWooCheckout(e,c)}}):(console.log("ecster_wc.ecster_cart_key"),console.log(u.ecster_cart_key),document.querySelector("#ecster-pay-ctr").innerHTML='<div class="woocommerce-error">'+u.ecster_cart_key+"</div>"))},wc_ecster_update_cart:function(){var c,e;!1!==u.wc_ecster_initialized&&(c=EcsterPay.updateCart(u.ecster_cart_key),e=_('input[name="ecster-customer-type"]:checked').val()?_('input[name="ecster-customer-type"]:checked').val():null,_.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_update_cart",cart_key:u.ecster_cart_key,customer_type:e,nonce:ecster_wc_params.wc_ecster_nonce},success:function(e){e.success&&e.data.refreshZeroAmount&&window.location.reload(),e.success&&e.data.ecster_cart_key?(c(e.data.ecster_cart_key),u.ecster_cart_key=e.data.ecster_cart_key):_("#ecster-pay-ctr").html('<div class="woocommerce-error" id="wc-ecster-api-error">'+e.data.error_message+"</div>")}}))},wc_ecster_fail_local_order:function(e){_.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_fail_local_order",reason:e,nonce:ecster_wc_params.wc_ecster_nonce}})},wc_ecster_on_checkout_start_failure:function(e){!0!==u.wc_ecster_order_processing?_.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_checkout_start_failure",payment_data:e,nonce:ecster_wc_params.wc_ecster_nonce},success:function(){window.location.reload(!0)}}):console.log("Aborting Ecster on_checkout_start_failure. Order processing active.")},wc_ecster_on_customer_authenticated:function(o){_("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),_.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_customer_authenticated",customer_data:o,nonce:ecster_wc_params.wc_ecster_nonce},success:function(e){var c=o.countryCode||"SE";_("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),_("form.checkout #billing_country").val(c),_("form.checkout #billing_postcode").val(o.zip),console.log("Customer authenticated sucess"),console.log(e),_("body").trigger("update_checkout")}})},wc_ecster_on_changed_delivery_address:function(c){_.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_changed_delivery_address",delivery_address:c,nonce:ecster_wc_params.wc_ecster_nonce},success:function(){var e=c.countryCode||"SE";u.wc_ecster_on_customer_authenticated_data?(_("form.checkout #ship-to-different-address-checkbox").prop("checked",!0),_("form.checkout #shipping_country").val(e),_("form.checkout #shipping_postcode").val(c.zip)):(_("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),_("form.checkout #billing_country").val(e),_("form.checkout #billing_postcode").val(c.zip)),console.log("Customer changed delivery address sucess"),_("body").trigger("update_checkout")}})},wc_ecster_on_payment_success:function(e){_("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),_("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var c=sessionStorage.getItem("ecsterRedirectUrl");console.log("wc_ecster_on_payment_success"),console.log(c),c&&(c=c+"&ecster_order_id="+e.internalReference,console.log(c),window.location.href=c)},processWooCheckout:function(e,c){_("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),_("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),console.log("processWooCheckout"),console.log(u.wc_ecster_on_customer_authenticated_data),u.fillForm(),u.submitForm(c)},fillForm:function(){var e;console.log("fillForm"),e=u.wc_ecster_on_changed_delivery_address_data||u.wc_ecster_on_customer_authenticated_data,console.log("customer"),console.log(e);var c="firstName"in e?e.firstName:"",o="lastName"in e?e.lastName:"",t="city"in e?e.city:"",r="countryCode"in e?e.countryCode:"",a="zip"in e?e.zip:"",s="address"in e?e.address:"",n="email"in e?e.email:"ecster.temp@domain.com",l="cellular"in e?e.cellular:".";customerType=0<_("input[name='ecster-customer-type']").length?_("input[name='ecster-customer-type']:checked").val():ecster_wc_params.default_customer_type,"b2b"===customerType?_("form.checkout #billing_company").val(e.address2):(_("form.checkout #billing_company").val(""),_("form.checkout #billing_address_2").val(e.address2)),_("#billing_first_name").val(c),_("#shipping_first_name").val(c),_("#billing_last_name").val(o),_("#shipping_last_name").val(o),r&&(_("#billing_country").val(r),_("#shipping_country").val(r)),_("#billing_address_1").val(s),_("#shipping_address_1").val(s),_("#billing_city").val(t),_("#shipping_city").val(t),_("#billing_postcode").val(a),_("#shipping_postcode").val(a),_("#billing_phone").val(l),_("#billing_email").val(n)},submitForm:function(o){console.log("submitForm"),0<_("form.checkout #terms").length&&_("form.checkout #terms").prop("checked",!0),_(".woocommerce-checkout-review-order-table").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),_.ajax({type:"POST",url:ecster_wc_params.submit_order,timeout:1e3*ecster_wc_params.timeout_time,data:_("form.checkout").serialize(),dataType:"json",success:function(c){try{"success"===c.result?(u.logToFile('Successfully placed order. Sending "beforeSubmitContinue" true to Ecster Pay'),console.log("data.redirect_url"),console.log(c.redirect_url),sessionStorage.setItem("ecsterRedirectUrl",c.redirect_url),o(!0),clearInterval(u.interval),clearTimeout(u.timeout),_("form.checkout").removeClass("processing").unblock(),_(".woocommerce-checkout-review-order-table").unblock(),_("#ecster-pay-ctr").unblock(),console.log("submitForm end - callback true triggered")):c.messages?(u.logToFile("Checkout error | "+c.messages),u.failOrder("submission",c.messages,o)):(u.logToFile("Checkout error | No message"),u.failOrder("submission",'<div class="woocommerce-error">Checkout error</div>',o))}catch(e){c.messages?(u.logToFile("Checkout error | "+c.messages),u.failOrder("submission",c.messages,o)):(u.logToFile("Checkout error | No message"),u.failOrder("submission",'<div class="woocommerce-error">Checkout error</div>',o))}},error:function(e,c){u.logToFile("AJAX error | "+e.statusText),u.failOrder("ajax-error","Ecster checkout error: "+e.statusText,o)}})},maybeChangeToEcster:function(){"ecster"===_(this).val()&&u.changePaymentMethod(!0)},changePaymentMethod:function(e){console.log("Ecster changePaymentMethod"),console.log(e),!0!==u.wc_ecster_order_processing?(_("form.checkout").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),_(".woocommerce-info").remove(),_.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{ecster:e,action:"wc_change_to_ecster",nonce:ecster_wc_params.wc_change_to_ecster_nonce},success:function(e){},error:function(e){},complete:function(e){console.log(e),window.location.href=e.responseJSON.data.redirect}})):console.log("Aborting Ecster change payment method. Order processing active.")},failOrder:function(e,c,o){console.log("failOrder"),console.log(e),clearInterval(u.interval),clearTimeout(u.timeout),o(!1),_("body").trigger("updated_checkout"),_(u.checkoutFormSelector).unblock(),_(".woocommerce-checkout-review-order-table").unblock(),_(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),_("form.checkout").prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout"><ul class="woocommerce-error" role="alert"><li>'+c+"</li></ul></div>"),_("form.checkout").removeClass("processing").unblock(),_("form.checkout").find(".input-text, select, input:checkbox").trigger("validate").blur(),_(document.body).trigger("checkout_error",[c]),_("html, body").animate({scrollTop:_("form.checkout").offset().top-100},1e3)},checkUrl:function(e){var c;!window.location.hash||-1<(c=window.location.hash).indexOf("#ecster-success")&&(u.logToFile("ecster-success hashtag detected in URL."),c=c.split("="),console.log("splittedHash"),console.log(c[0]),console.log(c[1]),c=JSON.parse(atob(c[1])),console.log("response.return_url"),console.log(c.return_url),sessionStorage.setItem("ecsterRedirectUrl",c.return_url),e(!0),clearInterval(u.interval),clearTimeout(u.timeout),_(".woocommerce-checkout-review-order-table").unblock(),console.log("checkUrl end - callback true triggered"))},logToFile:function(e){_.ajax({url:ecster_wc_params.ajaxurl,type:"POST",dataType:"json",data:{action:"wc_ecster_log_js_to_file",message:e,nonce:ecster_wc_params.wc_ecster_nonce}})}};u.init()});