!function(r){"use strict";function c(){"ecster"===r("input[name='payment_method']:checked").val()?r("body").addClass("ecster-selected").removeClass("ecster-deselected"):r("body").removeClass("ecster-selected").addClass("ecster-deselected")}function o(){var c=EcsterPay.updateCart(n),e=r('input[name="ecster-customer-type"]:checked').val()?r('input[name="ecster-customer-type"]:checked').val():null;r.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_update_cart",cart_key:n,customer_type:e,nonce:wc_ecster.wc_ecster_nonce},success:function(e){e.success&&e.data.refreshZeroAmount&&window.location.reload(),e.success&&e.data.wc_ecster_cart_key?(c(e.data.wc_ecster_cart_key),n=e.data.wc_ecster_cart_key):r("#ecster-pay-ctr").html('<div class="woocommerce-error" id="wc-ecster-api-error">'+e.data.error_message+"</div>")}})}function e(){r("#order_comments").appendTo("#ecster-extra-checkout-fields"),console.log("create"),"ecster"===r("input[name='payment_method']:checked").val()&&"object"==typeof window.EcsterPay&&r("#ecster-pay-ctr").length&&(null!==n&&!0!==n.includes("Error")?EcsterPay.start({cartKey:n,shopTermsUrl:wc_ecster.terms,showCart:!1,showPaymentResult:!1,onCheckoutStartInit:function(){r("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutStartSuccess:function(){r("#order_review").unblock(),t=!0,r("body").trigger("update_checkout")},onCheckoutStartFailure:function(e){r("#order_review").unblock(),console.log("onCheckoutStartFailure"),console.log(e),u(e)},onCheckoutUpdateInit:function(){r("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutUpdateSuccess:function(){r("#order_review").unblock(),r("#ecster-pay-ctr").unblock()},onCheckoutUpdateFailure:function(){r("#order_review").unblock()},onCustomerAuthenticated:function(e){a=e.customer,l(e.customer)},onChangedDeliveryMethod:function(e){},onChangedDeliveryAddress:function(e){d(e)},onPaymentSuccess:function(e){m(e)},onPaymentFailure:function(){i("failed")},onPaymentDenied:function(e){i("denied")}}):(console.log("wc_ecster_cart_key"),console.log(n),document.querySelector("#ecster-pay-ctr").innerHTML='<div class="woocommerce-error">'+n+"</div>"))}var t=!1,n=null,a=!1,n=wc_ecster.ecster_checkout_cart_key,s=!1,i=function(e){r.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_fail_local_order",reason:e,nonce:wc_ecster.wc_ecster_nonce}})},u=function(e){!0!==s?r.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_checkout_start_failure",payment_data:e,nonce:wc_ecster.wc_ecster_nonce},success:function(){window.location.reload(!0)}}):console.log("Aborting Ecster on_checkout_start_failure. Order processing active.")},l=function(o){r("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),r.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_customer_authenticated",customer_data:o,nonce:wc_ecster.wc_ecster_nonce},success:function(e){var c=o.countryCode||"SE";r("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),r("form.checkout #billing_country").val(c),r("form.checkout #billing_postcode").val(o.zip),console.log("Customer authenticated sucess"),console.log(e),"yes"==e.data.mustLogin?(r("form.checkout").prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-updateOrderReview"><ul class="woocommerce-error" role="alert"><li>'+e.data.mustLoginMessage+"</li></ul></div>"),e=r("form.checkout").offset().top,r("html, body").animate({scrollTop:e},1e3)):r("body").trigger("update_checkout")}})},d=function(c){r.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_changed_delivery_address",delivery_address:c,nonce:wc_ecster.wc_ecster_nonce},success:function(){var e=c.countryCode||"SE";a?(r("form.checkout #ship-to-different-address-checkbox").prop("checked",!0),r("form.checkout #shipping_country").val(e),r("form.checkout #shipping_postcode").val(c.zip)):(r("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),r("form.checkout #billing_country").val(e),r("form.checkout #billing_postcode").val(c.zip)),r("body").trigger("update_checkout")}})};var m=function(t){r("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),r("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),r.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_payment_success",payment_data:t,nonce:wc_ecster.wc_ecster_nonce},success:function(e){var c,o;console.log("wc_ecster_on_payment_success success"),!1===e.success?(console.log("already exist in order"),console.log(e),e.data.redirect&&(window.location.href=e.data.redirect)):(r("#ship-to-different-address-checkbox").prop("checked",!0),0<r("input[name='ecster-customer-type']").length&&(o=r("input[name='ecster-customer-type']:checked").val()),c=t.consumer.address.country||"SE",e=-1<t.consumer.contactInfo.cellular.number.indexOf("*")?"0":t.consumer.contactInfo.cellular.number,r("form.checkout #billing_first_name").val(t.consumer.name.firstName),r("form.checkout #billing_last_name").val(t.consumer.name.lastName),r("form.checkout #billing_email").val(t.consumer.contactInfo.email),r("form.checkout #billing_country").val(c),r("form.checkout #billing_address_1").val(t.consumer.address.line1),r("form.checkout #billing_city").val(t.consumer.address.city),r("form.checkout #billing_postcode").val(t.consumer.address.zip),r("form.checkout #billing_phone").val(e),"b2b"===o?r("form.checkout #billing_company").val(t.consumer.address.line2):(r("form.checkout #billing_company").val(""),r("form.checkout #billing_address_2").val(t.consumer.address.line2)),t.recipient?(r("form.checkout #shipping_first_name").val(t.recipient.name.firstName),r("form.checkout #shipping_last_name").val(t.recipient.name.lastName),r("form.checkout #shipping_country").val(t.recipient.address.country),r("form.checkout #shipping_address_1").val(t.recipient.address.line1),r("form.checkout #shipping_city").val(t.recipient.address.city),r("form.checkout #shipping_postcode").val(t.recipient.address.zip),"b2b"===o?r("form.checkout #shipping_company").val(t.recipient.address.line2):(r("form.checkout #shipping_company").val(""),r("form.checkout #shipping_address_2").val(t.recipient.address.line2))):r("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),0<r("form.checkout #terms").length&&r("form.checkout #terms").prop("checked",!0),console.log("submit Woo form"),s=!0,r("form.woocommerce-checkout").trigger("submit"),r("form.woocommerce-checkout").addClass("processing"))},error:function(e){console.log("wc_ecster_on_payment_success error")}})};function _(e){console.log("Ecster changePaymentMethod"),console.log(e),!0!==s?(r("form.checkout").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),r(".woocommerce-info").remove(),r.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{ecster:e,action:"wc_change_to_ecster",nonce:wc_ecster.wc_change_to_ecster_nonce},success:function(e){},error:function(e){},complete:function(e){console.log(e),window.location.href=e.responseJSON.data.redirect}})):console.log("Aborting Ecster change payment method. Order processing active.")}r(document).ready(function(){c(),e()}),r(document.body).on("change","input[name='payment_method']",function(e){c(),"ecster"===e.target.value&&r("body").trigger("update_checkout")}),r(document.body).on("change","input[name='ecster-customer-type']",function(e){o()}),r(document.body).on("updated_checkout",function(){"ecster"===r("input[name='payment_method']:checked").val()&&(t?o:e)()}),r(document.body).on("click",".ecster-pay-choose-other a",function(e){_(!1)}),r(document.body).on("checkout_error",function(){var e;"ecster"===r("input[name='payment_method']:checked").val()&&(e=r(".woocommerce-NoticeGroup-checkout").text(),r.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{cart_key:n,error_message:e,action:"wc_ecster_on_checkout_error",nonce:wc_ecster.wc_ecster_nonce},success:function(e){},error:function(e){},complete:function(e){console.log("ecster checkout error"),console.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}}))}),r(document.body).on("change",'input[name="payment_method"]',function(){"ecster"===r(this).val()&&_(!0)})}(jQuery);