!function(n){"use strict";function c(){"ecster"===n("input[name='payment_method']:checked").val()?n("body").addClass("ecster-selected").removeClass("ecster-deselected"):n("body").removeClass("ecster-selected").addClass("ecster-deselected")}function o(){var c=EcsterPay.updateCart(r),e=n('input[name="ecster-customer-type"]:checked').val()?n('input[name="ecster-customer-type"]:checked').val():null;n.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_update_cart",cart_key:r,customer_type:e,nonce:wc_ecster.wc_ecster_nonce},success:function(e){e.success&&e.data.wc_ecster_cart_key?(c(e.data.wc_ecster_cart_key),r=e.data.wc_ecster_cart_key):n("#ecster-pay-ctr").html('<div class="woocommerce-error" id="wc-ecster-api-error">'+e.data.error_message+"</div>")}})}function e(){console.log("create"),"ecster"===n("input[name='payment_method']:checked").val()&&"object"==typeof window.EcsterPay&&n("#ecster-pay-ctr").length&&null!==r&&EcsterPay.start({cartKey:r,shopTermsUrl:wc_ecster.terms,showCart:!1,showPaymentResult:!1,onCheckoutStartInit:function(){n("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutStartSuccess:function(){n("#order_review").unblock(),t=!0,n("body").trigger("update_checkout")},onCheckoutStartFailure:function(e){n("#order_review").unblock()},onCheckoutUpdateInit:function(){n("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutUpdateSuccess:function(){n("#order_review").unblock(),n("#ecster-pay-ctr").unblock()},onCheckoutUpdateFailure:function(){n("#order_review").unblock()},onCustomerAuthenticated:function(e){a=e.customer,u(e.customer)},onChangedDeliveryMethod:function(e){},onChangedDeliveryAddress:function(e){i(e)},onPaymentSuccess:function(e){d(e)},onPaymentFailure:function(){s("failed")},onPaymentDenied:function(e){s("denied")}})}var t=!1,r=null,a=!1,s=(r=wc_ecster.ecster_checkout_cart_key,function(e){n.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_fail_local_order",reason:e,nonce:wc_ecster.wc_ecster_nonce}})}),u=function(t){n("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),n.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_customer_authenticated",customer_data:t,nonce:wc_ecster.wc_ecster_nonce},success:function(e){var c;if(c=t.countryCode?t.countryCode:"SE",n("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),n("form.checkout #billing_country").val(c),n("form.checkout #billing_postcode").val(t.zip),console.log("Customer authenticated sucess"),console.log(e),"yes"==e.data.mustLogin){n("form.checkout").prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-updateOrderReview"><ul class="woocommerce-error" role="alert"><li>'+e.data.mustLoginMessage+"</li></ul></div>");var o=n("form.checkout").offset().top;n("html, body").animate({scrollTop:o},1e3)}else n("body").trigger("update_checkout")}})},i=function(c){n.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_changed_delivery_address",delivery_address:c,nonce:wc_ecster.wc_ecster_nonce},success:function(){var e;e=c.countryCode?c.countryCode:"SE",a?(n("form.checkout #ship-to-different-address-checkbox").prop("checked",!0),n("form.checkout #shipping_country").val(e),n("form.checkout #shipping_postcode").val(c.zip)):(n("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),n("form.checkout #billing_country").val(e),n("form.checkout #billing_postcode").val(c.zip)),n("body").trigger("update_checkout")}})},d=function(o){n("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),n("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),n.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_payment_success",payment_data:o,nonce:wc_ecster.wc_ecster_nonce},success:function(){var e,c;console.log("success"),n("#ship-to-different-address-checkbox").prop("checked",!0),e=o.consumer.countryCode?o.consumer.countryCode:"SE",c=-1<o.consumer.contactInfo.cellular.number.indexOf("*")?"0":o.consumer.contactInfo.cellular.number,n("form.checkout #billing_first_name").val(o.consumer.name.firstName),n("form.checkout #billing_last_name").val(o.consumer.name.lastName),n("form.checkout #billing_email").val(o.consumer.contactInfo.email),n("form.checkout #billing_country").val(e),n("form.checkout #billing_address_1").val(o.consumer.address.line1),n("form.checkout #billing_city").val(o.consumer.address.city),n("form.checkout #billing_postcode").val(o.consumer.address.zip),n("form.checkout #billing_phone").val(c),o.recipient?(n("form.checkout #shipping_first_name").val(o.recipient.name.firstName),n("form.checkout #shipping_last_name").val(o.recipient.name.lastName),n("form.checkout #shipping_country").val(o.recipient.address.country),n("form.checkout #shipping_address_1").val(o.recipient.address.line1),n("form.checkout #shipping_city").val(o.recipient.address.city),n("form.checkout #shipping_postcode").val(o.recipient.address.zip)):n("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),0<n("form.checkout #terms").length&&n("form.checkout #terms").prop("checked",!0),console.log("submit"),n("form.woocommerce-checkout").trigger("submit")}})};function l(e){console.log(e),n("form.checkout").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),n(".woocommerce-info").remove(),n.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{ecster:e,action:"wc_change_to_ecster",nonce:wc_ecster.wc_change_to_ecster_nonce},success:function(e){},error:function(e){},complete:function(e){console.log(e),window.location.href=e.responseJSON.data.redirect}})}n(document).ready(function(){c(),e()}),n(document.body).on("change","input[name='payment_method']",function(e){c(),"ecster"===e.target.value&&n("body").trigger("update_checkout")}),n(document.body).on("change","input[name='ecster-customer-type']",function(e){o()}),n(document.body).on("updated_checkout",function(){"ecster"===n("input[name='payment_method']:checked").val()&&((t?o:e)(),1==wc_ecster.add_change_method_button&&(wc_ecster.add_change_method_button=0,n('<p><a href="#" class="button">'+wc_ecster.select_another_method_text+"</a></p>").appendTo("#ecster-wrapper").addClass("ecster-pay-choose-other")))}),n(document.body).on("click",".ecster-pay-choose-other a",function(e){l(!1)}),n(document.body).on("checkout_error",function(){"ecster"===n("input[name='payment_method']:checked").val()&&n.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{cart_key:r,action:"wc_ecster_on_checkout_error",nonce:wc_ecster.wc_ecster_nonce},success:function(e){},error:function(e){},complete:function(e){console.log("ecster checkout error"),console.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})}),n(document.body).on("change",'input[name="payment_method"]',function(){"ecster"===n(this).val()&&l(!0)})}(jQuery);