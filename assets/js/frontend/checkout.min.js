jQuery(function(l){const _={wc_ecster_initialized:!1,ecster_cart_key:null,wc_ecster_on_customer_authenticated_data:!1,wc_ecster_on_changed_delivery_address_data:!1,ecster_cart_key:ecster_wc_params.ecster_checkout_cart_key,wc_ecster_order_processing:!1,paymentMethodEl:l('input[name="payment_method"]'),selectAnotherSelector:"#ecster-checkout-select-other",bodyEl:l("body"),init:function(){_.checkIfSelected()&&(l(document).ready(_.documentReady()),_.bodyEl.on("updated_checkout",_.wc_ecster_update_cart)),_.bodyEl.on("change",'input[name="payment_method"]',_.maybeChangeToEcster),_.bodyEl.on("click",_.selectAnotherSelector,function(){_.changePaymentMethod(!1)})},documentReady:function(){_.wc_ecster_body_class(),_.moveExtraCheckoutFields(),_.wc_ecster_create_cart()},checkIfSelected:function(){return 0<_.paymentMethodEl.length&&(_.paymentMethod=_.paymentMethodEl.filter(":checked").val(),"ecster"===_.paymentMethod)},wc_ecster_body_class:function(){"ecster"===l("input[name='payment_method']:checked").val()?l("body").addClass("ecster-selected").removeClass("ecster-deselected"):l("body").removeClass("ecster-selected").addClass("ecster-deselected")},moveExtraCheckoutFields:function(){l("#order_comments").appendTo("#ecster-extra-checkout-fields")},wc_ecster_create_cart:function(){console.log("create"),"ecster"===l("input[name='payment_method']:checked").val()&&"object"==typeof window.EcsterPay&&l("#ecster-pay-ctr").length&&(null!==_.ecster_cart_key&&!0!==_.ecster_cart_key.includes("Error")?EcsterPay.start({cartKey:_.ecster_cart_key,shopTermsUrl:ecster_wc_params.terms,showCart:!1,showPaymentResult:!1,onCheckoutStartInit:function(){l("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutStartSuccess:function(){l("#order_review").unblock(),_.wc_ecster_initialized=!0,l("body").trigger("update_checkout")},onCheckoutStartFailure:function(e){l("#order_review").unblock(),console.log("onCheckoutStartFailure"),console.log(e),_.wc_ecster_on_checkout_start_failure(e)},onCheckoutUpdateInit:function(){l("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutUpdateSuccess:function(){l("#order_review").unblock(),l("#ecster-pay-ctr").unblock()},onCheckoutUpdateFailure:function(){l("#order_review").unblock()},onCustomerAuthenticated:function(e){_.wc_ecster_on_customer_authenticated_data=e.customer,_.wc_ecster_on_customer_authenticated(e.customer)},onChangedDeliveryMethod:function(e){},onChangedDeliveryAddress:function(e){_.wc_ecster_on_changed_delivery_address_data=e,_.wc_ecster_on_changed_delivery_address(e)},onPaymentSuccess:function(e){_.wc_ecster_on_payment_success(e)},onPaymentFailure:function(){_.wc_ecster_fail_local_order("failed")},onPaymentDenied:function(e){_.wc_ecster_fail_local_order("denied")},onBeforeSubmit:function(e,c){console.log("onBeforeSubmit"),console.log(e),console.log(c),window.location.hash="",_.timeout=setTimeout(function(){_.failOrder("timeout",c)},1e3*ecster_wc_params.timeout_time),l(document.body).on("checkout_error",function(){_.failOrder("checkout_error",c)}),_.interval=setInterval(function(){_.checkUrl(c)},500),_.processWooCheckout(e)}}):(console.log("ecster_wc.ecster_cart_key"),console.log(_.ecster_cart_key),document.querySelector("#ecster-pay-ctr").innerHTML='<div class="woocommerce-error">'+_.ecster_cart_key+"</div>"))},wc_ecster_update_cart:function(){var c,e;!1!==_.wc_ecster_initialized&&(c=EcsterPay.updateCart(_.ecster_cart_key),e=l('input[name="ecster-customer-type"]:checked').val()?l('input[name="ecster-customer-type"]:checked').val():null,l.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_update_cart",cart_key:_.ecster_cart_key,customer_type:e,nonce:ecster_wc_params.wc_ecster_nonce},success:function(e){e.success&&e.data.refreshZeroAmount&&window.location.reload(),e.success&&e.data.ecster_cart_key?(c(e.data.ecster_cart_key),_.ecster_cart_key=e.data.ecster_cart_key):l("#ecster-pay-ctr").html('<div class="woocommerce-error" id="wc-ecster-api-error">'+e.data.error_message+"</div>")}}))},wc_ecster_fail_local_order:function(e){l.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_fail_local_order",reason:e,nonce:ecster_wc_params.wc_ecster_nonce}})},wc_ecster_on_checkout_start_failure:function(e){!0!==_.wc_ecster_order_processing?l.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_checkout_start_failure",payment_data:e,nonce:ecster_wc_params.wc_ecster_nonce},success:function(){window.location.reload(!0)}}):console.log("Aborting Ecster on_checkout_start_failure. Order processing active.")},wc_ecster_on_customer_authenticated:function(t){l("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),l.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_customer_authenticated",customer_data:t,nonce:ecster_wc_params.wc_ecster_nonce},success:function(e){var c=t.countryCode||"SE";l("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),l("form.checkout #billing_country").val(c),l("form.checkout #billing_postcode").val(t.zip),console.log("Customer authenticated sucess"),console.log(e),l("body").trigger("update_checkout")}})},wc_ecster_on_changed_delivery_address:function(c){l.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_changed_delivery_address",delivery_address:c,nonce:ecster_wc_params.wc_ecster_nonce},success:function(){var e=c.countryCode||"SE";_.wc_ecster_on_customer_authenticated_data?(l("form.checkout #ship-to-different-address-checkbox").prop("checked",!0),l("form.checkout #shipping_country").val(e),l("form.checkout #shipping_postcode").val(c.zip)):(l("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),l("form.checkout #billing_country").val(e),l("form.checkout #billing_postcode").val(c.zip)),l("body").trigger("update_checkout")}})},wc_ecster_on_payment_success:function(e){l("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),l("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var c=sessionStorage.getItem("ecsterRedirectUrl");console.log("wc_ecster_on_payment_success"),console.log(c),c&&(c=c+"&ecster_order_id="+e.internalReference,console.log(c),window.location.href=c)},processWooCheckout:function(e){l("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),l("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),console.log("processWooCheckout"),console.log(_.wc_ecster_on_customer_authenticated_data),_.fillForm(),_.submitForm()},fillForm:function(){console.log("fillForm");var e=_.wc_ecster_on_customer_authenticated_data,c="firstName"in e?e.firstName:"",t="lastName"in e?e.lastName:"",o="city"in e?e.city:"",r="countryCode"in e?e.countryCode:"",a="email"in e?e.email:"",n="cellular"in e?e.cellular:"",s="zip"in e?e.zip:"",e="address"in e?e.address:"";console.log("fillForm2"),0<l("input[name='ecster-customer-type']").length&&(customerType=l("input[name='ecster-customer-type']:checked").val()),console.log("fillForm22"),console.log("fillForm23"),l("#billing_first_name").val(c),l("#shipping_first_name").val(c),console.log("fillForm24"),l("#billing_last_name").val(t),l("#shipping_last_name").val(t),console.log("fillForm3"),r&&(l("#billing_country").val(r),l("#shipping_country").val(r)),l("#billing_address_1").val(e),l("#shipping_address_1").val(e),l("#billing_city").val(o),l("#shipping_city").val(o),l("#billing_postcode").val(s),l("#shipping_postcode").val(s),l("#billing_phone").val(n),l("#billing_email").val(a),console.log("fillForm4")},submitForm:function(){console.log("submitForm"),0<l("form.checkout #terms").length&&l("form.checkout #terms").prop("checked",!0),l("form.checkout").submit()},maybeChangeToEcster:function(){"ecster"===l(this).val()&&_.changePaymentMethod(!0)},changePaymentMethod:function(e){console.log("Ecster changePaymentMethod"),console.log(e),!0!==_.wc_ecster_order_processing?(l("form.checkout").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),l(".woocommerce-info").remove(),l.ajax(ecster_wc_params.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{ecster:e,action:"wc_change_to_ecster",nonce:ecster_wc_params.wc_change_to_ecster_nonce},success:function(e){},error:function(e){},complete:function(e){console.log(e),window.location.href=e.responseJSON.data.redirect}})):console.log("Aborting Ecster change payment method. Order processing active.")},failOrder:function(e,c){console.log("failOrder"),console.log(e),l("#order_review").unblock(),l("form.checkout").unblock(),l("form.checkout").removeClass("processing"),l("#ecster-wrapper").unblock(),c(!1)},checkUrl:function(e){var c;!window.location.hash||-1<(c=window.location.hash).indexOf("#ecster-success")&&(c=c.split("="),console.log("splittedHash"),console.log(c[0]),console.log(c[1]),c=JSON.parse(atob(c[1])),window.dibsRedirectUrl=c.redirect_url,console.log("response.return_url"),console.log(c.return_url),sessionStorage.setItem("ecsterRedirectUrl",c.return_url),e(!0),clearInterval(_.interval),clearTimeout(_.timeout),l(".woocommerce-checkout-review-order-table").unblock(),console.log("checkUrl end - callback true triggered"))}};_.init()});