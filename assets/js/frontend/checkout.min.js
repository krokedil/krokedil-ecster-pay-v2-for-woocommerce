!function(i){"use strict";function o(){"ecster"===i("input[name='payment_method']:checked").val()?i("body").addClass("ecster-selected").removeClass("ecster-deselected"):i("body").removeClass("ecster-selected").addClass("ecster-deselected")}function e(){console.log("create"),"ecster"===i("input[name='payment_method']:checked").val()&&"object"==typeof window.EcsterPay&&i("#ecster-pay-ctr").length&&(null!==r&&!0!==r.includes("Error")?EcsterPay.start({cartKey:r,shopTermsUrl:wc_ecster.terms,showCart:!1,showPaymentResult:!1,onCheckoutStartInit:function(){i("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutStartSuccess:function(){i("#order_review").unblock(),n=!0,i("body").trigger("update_checkout")},onCheckoutStartFailure:function(e){i("#order_review").unblock(),console.log("onCheckoutStartFailure"),console.log(e),s(e)},onCheckoutUpdateInit:function(){i("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutUpdateSuccess:function(){i("#order_review").unblock(),i("#ecster-pay-ctr").unblock()},onCheckoutUpdateFailure:function(){i("#order_review").unblock()},onCustomerAuthenticated:function(e){u=e.customer,l(e.customer)},onChangedDeliveryMethod:function(e){},onChangedDeliveryAddress:function(e){d(e)},onPaymentSuccess:function(e){_(e)},onPaymentFailure:function(){a("failed")},onPaymentDenied:function(e){a("denied")},onBeforeSubmit:function(e,o){console.log("onBeforeSubmit"),console.log(e),console.log(o),console.log("hej"),window.location.hash="",wc_ecster.timeout=setTimeout(function(){p("timeout",o)},1e3*wc_ecster.timeout_time),i(document.body).on("checkout_error",function(){p("checkout_error",o)}),wc_ecster.interval=setInterval(function(){!function(e){if(window.location.hash){var o=window.location.hash;if(-1<o.indexOf("#ecster-success")){var c=o.split("=");console.log("splittedHash"),console.log(c[0]),console.log(c[1]);var t=JSON.parse(atob(c[1]));window.dibsRedirectUrl=t.redirect_url,console.log("response.return_url"),console.log(t.return_url),sessionStorage.setItem("ecsterRedirectUrl",t.return_url),e(!0),clearInterval(wc_ecster.interval),clearTimeout(wc_ecster.timeout),i(".woocommerce-checkout-review-order-table").unblock(),console.log("checkUrl end - callback true triggered")}}}(o)},500),i("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),i("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),console.log("wc_ecster_on_customer_authenticated_data"),console.log(u),function(){console.log("fillForm");var e=u,o="firstName"in e?e.firstName:"",c="lastName"in e?e.lastName:"",t="city"in e?e.city:"",n="countryCode"in e?e.countryCode:"",r="email"in e?e.email:"",a="cellular"in e?e.cellular:"",s="zip"in e?e.zip:"",l="address"in e?e.address:"";console.log("fillForm2"),0<i("input[name='ecster-customer-type']").length&&(customerType=i("input[name='ecster-customer-type']:checked").val());console.log("fillForm22"),console.log("fillForm23"),i("#billing_first_name").val(o),i("#shipping_first_name").val(o),console.log("fillForm24"),i("#billing_last_name").val(c),i("#shipping_last_name").val(c),console.log("fillForm3"),n&&(i("#billing_country").val(n),i("#shipping_country").val(n));i("#billing_address_1").val(l),i("#shipping_address_1").val(l),i("#billing_city").val(t),i("#shipping_city").val(t),i("#billing_postcode").val(s),i("#shipping_postcode").val(s),i("#billing_phone").val(a),i("#billing_email").val(r),console.log("fillForm4")}(),function(){console.log("submitForm"),0<i("form.checkout #terms").length&&i("form.checkout #terms").prop("checked",!0);i("form.checkout").submit()}()}}):(console.log("wc_ecster_cart_key"),console.log(r),document.querySelector("#ecster-pay-ctr").innerHTML='<div class="woocommerce-error">'+r+"</div>"))}function c(){var o=EcsterPay.updateCart(r),e=i('input[name="ecster-customer-type"]:checked').val()?i('input[name="ecster-customer-type"]:checked').val():null;i.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_update_cart",cart_key:r,customer_type:e,nonce:wc_ecster.wc_ecster_nonce},success:function(e){e.success&&e.data.refreshZeroAmount&&window.location.reload(),e.success&&e.data.wc_ecster_cart_key?(o(e.data.wc_ecster_cart_key),r=e.data.wc_ecster_cart_key):i("#ecster-pay-ctr").html('<div class="woocommerce-error" id="wc-ecster-api-error">'+e.data.error_message+"</div>")}})}function t(){i("#order_comments").appendTo("#ecster-extra-checkout-fields"),e()}var n=!1,r=null,u=!1,a=(r=wc_ecster.ecster_checkout_cart_key,function(e){i.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_fail_local_order",reason:e,nonce:wc_ecster.wc_ecster_nonce}})}),s=function(e){i.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_checkout_start_failure",payment_data:e,nonce:wc_ecster.wc_ecster_nonce},success:function(){window.location.reload(!0)}})},l=function(t){i("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),i.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_customer_authenticated",customer_data:t,nonce:wc_ecster.wc_ecster_nonce},success:function(e){var o;if(o=t.countryCode?t.countryCode:"SE",i("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),i("form.checkout #billing_country").val(o),i("form.checkout #billing_postcode").val(t.zip),console.log("Customer authenticated sucess"),console.log(e),"yes"==e.data.mustLogin){i("form.checkout").prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-updateOrderReview"><ul class="woocommerce-error" role="alert"><li>'+e.data.mustLoginMessage+"</li></ul></div>");var c=i("form.checkout").offset().top;i("html, body").animate({scrollTop:c},1e3)}else i("body").trigger("update_checkout")}})},d=function(o){i.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_changed_delivery_address",delivery_address:o,nonce:wc_ecster.wc_ecster_nonce},success:function(){var e;e=o.countryCode?o.countryCode:"SE",u?(i("form.checkout #ship-to-different-address-checkbox").prop("checked",!0),i("form.checkout #shipping_country").val(e),i("form.checkout #shipping_postcode").val(o.zip)):(i("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),i("form.checkout #billing_country").val(e),i("form.checkout #billing_postcode").val(o.zip)),i("body").trigger("update_checkout")}})};var _=function(){i("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),i("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var e=sessionStorage.getItem("ecsterRedirectUrl");console.log("wc_ecster_on_payment_success"),console.log(e),e&&(window.location.href=e)};function m(e){console.log("Ecster changePaymentMethod"),console.log(e),i("form.checkout").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),i(".woocommerce-info").remove(),i.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{ecster:e,action:"wc_change_to_ecster",nonce:wc_ecster.wc_change_to_ecster_nonce},success:function(e){},error:function(e){},complete:function(e){console.log(e),window.location.href=e.responseJSON.data.redirect}})}function p(e,o){console.log("failOrder"),console.log(e),i("#order_review").unblock(),i("form.checkout").unblock(),i("form.checkout").removeClass("processing"),i("#ecster-wrapper").unblock(),o(!1)}i(document).ready(function(){o(),t()}),i(document.body).on("change","input[name='payment_method']",function(e){o(),"ecster"===e.target.value&&i("body").trigger("update_checkout")}),i(document.body).on("change","input[name='ecster-customer-type']",function(e){c()}),i(document.body).on("updated_checkout",function(){"ecster"===i("input[name='payment_method']:checked").val()&&(n?c:t)()}),i(document.body).on("click",".ecster-pay-choose-other a",function(e){m(!1)}),i(document.body).on("change",'input[name="payment_method"]',function(){"ecster"===i(this).val()&&m(!0)})}(jQuery);